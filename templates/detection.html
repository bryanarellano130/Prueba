{% extends 'base.html' %}
{% block title %}Detecci칩n y An치lisis{% endblock %}
{% block content %}
<h1>游댌 Detecci칩n y An치lisis</h1>
<p>Aplica el modelo de Machine Learning ({{ 'Real' if detector.model else 'Simulado' }}) para detectar amenazas.</p>
<div class="action-card">
<h2>1. Seleccionar Datos y Ejecutar Detecci칩n</h2>
<form method="POST" action="{{ url_for('detect') }}" id="detection-form">
<div class="form-group">
<label for="datasource">Fuente de Datos para Analizar:</label>
<select id="datasource" name="datasource" required>
<option value="">-- Selecciona una fuente --</option>
{% if has_processed_data %}
<option value="processed">Usar Datos Cargados y Preprocesados</option>
{% endif %}
{% if has_simulation_data %}
{# Aseg칰rate que la ruta POST /detect sepa preprocesar esto #}
<option value="simulation">Usar Datos de la 칔ltima Simulaci칩n (Requiere Preprocesamiento)</option>
{% endif %}
{# Podr칤as a침adir opci칩n 'upload_direct' si implementas carga directa aqu칤 #}
</select>
{# Mostrar advertencias sobre disponibilidad de datos #}
{% if not has_processed_data %}
<small style="color: orange; display: block; margin-top: 5px;">Opci칩n 'Datos Preprocesados' no disponible. Carga y preprocesa datos en la secci칩n 'Gesti칩n de Datos'.</small>
{% endif %}
{% if not has_simulation_data %}
<small style="color: orange; display: block; margin-top: 5px;">Opci칩n '칔ltima Simulaci칩n' no disponible. Ejecuta una simulaci칩n primero.</small>
{% endif %}
</div>
<div class="form-group">
{# Este bot칩n ahora se maneja con JS si usas el ejemplo AJAX, si no, funciona como submit normal #}
<button type="submit" class="button" {% if not has_processed_data and not has_simulation_data %}disabled{% endif %}>Iniciar Detecci칩n</button>
</div>
</form>
{# Indicador de carga para AJAX (inicialmente oculto) #}
<div id="loading-indicator" style="display: none; margin-top: 1rem;"><p><strong>Ejecutando detecci칩n... por favor espera.</strong></p>{# Podr칤as a침adir un spinner CSS aqu칤 #}</div>
</div>
{# 츼rea para mostrar resultados #}
<div id="detection-results-area">
{# Mostrar los 칰ltimos resultados si existen en la sesi칩n (cargados por GET) #}
{% if last_results %}
<div class="preview-section">
<h2>Resultados de la 칔ltima Detecci칩n ({{ last_results.timestamp | format_datetime }})</h2>
{# --- NUEVA SECCI칍N PARA REPORTES --- #}
<div style="margin-top: 1.5rem; margin-bottom: 1.5rem;">
<h3>Reportes</h3>
<p>Descarga los resultados de esta detecci칩n en diferentes formatos:</p>
<a href="{{ url_for('download_last_detection_csv') }}" class="button button-secondary">Descargar CSV</a>
{# A침adiremos el enlace para PDF aqu칤 m치s tarde #}
{# <a href="{{ url_for('download_last_detection_pdf') }}" class="button button-secondary">Descargar PDF</a> #}
</div>
{# --- FIN SECCI칍N REPORTES --- #}
{# Mostrar M칠tricas #}
{# Este bloque muestra las m칠tricas para el *칰ltimo* resultado de detecci칩n (last_results) #}
{% if last_results.metrics and last_results.metrics.accuracy is not none %}
<h3>M칠tricas de Rendimiento</h3>
<p><strong>Exactitud (Accuracy):</strong> {{ "%.4f" % last_results.metrics.accuracy }} ({{ "%.2f%%" % (last_results.metrics.accuracy * 100) }})</p>
{# Mostrar Matriz de Confusi칩n si la URL de la imagen existe #}
{% if cm_plot_url %}
<div style="margin-top: 1rem; margin-bottom: 1rem;">
<h4>Matriz de Confusi칩n:</h4>
<img src="{{ cm_plot_url }}" alt="Matriz de Confusi칩n" style="max-width: 400px; height: auto; border: 1px solid #ccc;">
</div>
{% endif %}
{# Mostrar Reporte de Clasificaci칩n si el DataFrame existe #}
{% if report_df is not none %}
<div style="margin-top: 1rem; margin-bottom: 1rem;">
<h4>Reporte de Clasificaci칩n:</h4>
<div class="table-container" style="max-height: 300px;">{# Limitar altura #}
{# Renderizamos la cadena HTML generada en app.py. Usamos el filtro | safe para renderizar HTML crudo. #}
{{ report_df.to_html(classes=['data-table', 'table-sm'], border=0, float_format='%.4f') | safe }}
</div>
</div>
{% endif %}
{% else %}
<p>No se calcularon m칠tricas detalladas (posiblemente faltan etiquetas 'label' en los datos analizados).</p>
{% endif %}
{# Mostrar Vista Previa de Datos con Predicciones #}
{# Modificamos la condici칩n para chequear si la variable data_head_html existe #}
{% if data_head_html is not none %}
<h3 style="margin-top: 2rem;">Vista Previa de Predicciones (Primeras 5 Filas)</h3>{# Actualizamos el t칤tulo #}
<div class="table-container" style="max-height: 500px;">
{# Renderizamos la cadena HTML generada en app.py. Usamos el filtro | safe para renderizar HTML crudo. #}
{{ data_head_html | safe }}
</div>
{# Opcional: Si quieres mostrar un mensaje diferente si last_results existe pero data_head_html es None (por ejemplo, si hubo un error al generarlo) #}
{# elif last_results and data_head_html is none %}
{# <p>No se pudo generar la vista previa de datos.</p> #}
{# end if #}
</div>
{% endif %}
{% else %}
{# Mensaje si no hay resultados previos #}
<p style="margin-top: 1rem;">Selecciona una fuente de datos y ejecuta la detecci칩n para ver los resultados aqu칤.</p>
{% endif %}
</div>
{# Historial de Detecciones #}
<div class="preview-section" style="margin-top: 2rem;">
<h2>Historial de Detecciones</h2>
{% if detection_history %}
<table class="data-table">
<thead>
<tr>
<th>Fecha</th>
<th>Tama침o Dataset</th>{# Nota: la variable en app.py es 'rows_analyzed' #}
<th>Umbral Modelo</th>
<th>Accuracy</th>
{# Podr칤as a침adir m치s columnas si guardas m치s info #}
</tr>
</thead>
<tbody>
{% for entry in detection_history | reverse %} {# M치s recientes primero #}
<tr>
<td>{{ entry.timestamp | format_datetime }}</td>{# Celda de Fecha #}
<td>{{ entry.rows_analyzed if entry.rows_analyzed is not none else 'N/A' }}</td>{# Celda Tama침o Dataset #}
<td>
{# C칩digo CORREGIDO para Umbral del Modelo #}
{% if entry.model_threshold is number %}
{{ "%.2f" % entry.model_threshold }}
{% elif entry.model_threshold is not none %}
{# Mostrar como est치 si no es n칰mero pero no None (ej: string) #}
{{ entry.model_threshold }}
{% else %}
N/A
{% endif %}
</td>
<td>
{# C칩digo CORREGIDO para M칠tricas (Precisi칩n) #}
{% if entry.metrics and entry.metrics.accuracy is defined and entry.metrics.accuracy is not none %}
{{ "%.4f" % entry.metrics.accuracy }}
{% else %}
N/A
{% endif %}
</td>
{# ... posibles otras celdas si las tienes ... #}
</tr>
{% endfor %}
</tbody>
</table>
{% else %}
<p>No hay historial de detecciones.</p>
{% endif %}
</div>
{% endblock %}
{# Puedes a침adir estilos espec칤ficos aqu칤 o en style.css #}
{% block extra_css %}
<style>
.data-table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
.data-table th, .data-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
.data-table th { background-color: #f2f2f2; }
.data-table tr:nth-child(even) { background-color: #f9f9f9; }
.data-table tr:hover { background-color: #e9e9e9; }
.table-container { max-height: 400px; overflow-y: auto; margin-top: 1rem; border: 1px solid #ccc; }
.data-table.table-sm th, .data-table.table-sm td { padding: 0.5rem; font-size: 0.9rem; }
</style>
{% endblock %}
{% block extra_js %}
{# Importar pandas via CDN SOLO si necesitas usar pandas.DataFrame en el template. #}
{# Es mejor pre-procesar los datos (como la lista de dicts para la vista previa) en la ruta Flask y pasar el HTML directamente. #}
{# Si la l칤nea `{% set preview_df = pandas.DataFrame(last_results.data_head) %}` te da error, significa que pandas no est치 disponible en Jinja por defecto. En ese caso, deber칤as pasar la tabla HTML ya generada desde la ruta Flask. #}
{# <script src="https://cdn.jsdelivr.net/npm/danfojs@1.1.2/lib/bundle.min.js"></script> #}
{# Aseg칰rate de que static/js/main.js est칠 correctamente cargado en base.html o aqu칤 si es necesario #}
{# <script src="{{ url_for('static', filename='js/main.js') }}"></script> #}
<script>
console.log("Detection JS loaded");
// Si no usas AJAX, puedes quitar el script AJAX de main.js o no a침adirlo aqu칤.
// Script simple para mostrar/ocultar indicador de carga si usas submit POST normal
const detectionForm = document.getElementById('detection-form');
const loadingIndicator = document.getElementById('loading-indicator');
if (detectionForm && loadingIndicator) {
detectionForm.addEventListener('submit', function() {
loadingIndicator.style.display = 'block';
// Deshabilitar el bot칩n para evitar m칰ltiples env칤os
detectionForm.querySelector('button[type="submit"]').disabled = true;
});
}
</script>
{% endblock %}