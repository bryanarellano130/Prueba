{% extends 'base.html' %}

{% block title %}Simulador de Amenazas{% endblock %}

{% block content %}
<h1> Simulador de Amenazas</h1>
<p>Genera escenarios de tr谩fico de red y ataques cibern茅ticos (usando l贸gica placeholder).</p>

<div class="action-card">
    <h2>Configurar y Ejecutar Simulaci贸n</h2>
    <form method="POST" action="{{ url_for('simulate') }}">
        <div class="form-group">
            <label for="duration">Duraci贸n (segundos):</label>
            {# --- CORRECCIN AQU: Comprobar si last_simulation_info existe --- #}
            <input type="number" id="duration" name="duration" value="{{ last_simulation_info.config.duration if last_simulation_info else 60 }}" min="5" max="3600" required>
        </div>
        <div class="form-group">
            <label for="intensity">Intensidad del Ataque (1=Baja, 10=Alta):</label>
            {# --- CORRECCIN AQU: Comprobar si last_simulation_info existe --- #}
            <input type="number" id="intensity" name="intensity" value="{{ last_simulation_info.config.intensity if last_simulation_info else 5 }}" min="1" max="10" required>
        </div>
        <div class="form-group">
            <label for="attacks">Tipos de ataques para simular (selecciona uno o m谩s con CTRL/CMD):</label>
            {# --- CORRECCIN AQU: Comprobar si last_simulation_info existe --- #}
            {% set last_attacks = last_simulation_info.config.attacks if last_simulation_info else ['DDoS', 'Scan'] %}
            <select id="attacks" name="attacks" multiple required size="4">
                {# Opciones posibles #}
                {% set possible_attacks = ['DDoS', 'Scan', 'Malware', 'Infiltration'] %}
                {% for attack_option in possible_attacks %}
                    <option value="{{ attack_option }}" {% if attack_option in last_attacks %}selected{% endif %}>
                        {# Mostrar nombres m谩s descriptivos si quieres #}
                        {% if attack_option == 'Scan' %}Escaneo de Puertos (Scan)
                        {% elif attack_option == 'Malware' %}Malware C&C
                        {% else %}{{ attack_option }}{% endif %}
                    </option>
                {% endfor %}
                {# A帽ade m谩s opciones si tu simulador las soporta #}
            </select>
        </div>
        <div class="form-group">
            <button type="submit" class="button">Ejecutar Simulaci贸n</button>
        </div>
    </form>
</div>

{# Mostrar vista previa de la 煤ltima simulaci贸n si existe #}
{% if last_simulation_preview_df is not none and not last_simulation_preview_df.empty %}
    <div class="preview-section">
        <h2>
            ltima Simulaci贸n Ejecutada
            {# Mostrar info si est谩 disponible #}
            {% if last_simulation_info %}
                 ({{ last_simulation_info.timestamp | format_datetime }}) -
                 {{ last_simulation_info.rows_generated }} regs generados
                 ({{ last_simulation_info.rows_in_session }} en vista previa)
            {% endif %}
        </h2>
        <div class="table-container">
            {# Renderizar el DataFrame pasado desde Flask #}
            {{ last_simulation_preview_df.to_html(classes=['data-table', 'table-sm'], border=0, index=False, max_rows=100) | safe }}
        </div>
        {# Opci贸n para usar estos datos en Detecci贸n (requiere l贸gica en la ruta /detect) #}
        <form method="POST" action="{{ url_for('detect') }}" style="margin-top: 1rem;">
             <input type="hidden" name="datasource" value="simulation">
             <button type="submit" class="button button-secondary">Usar estos datos para Detecci贸n (requiere preprocesamiento)</button>
        </form>
    </div>
{# Mostrar mensaje si se ejecut贸 pero no hay datos (ej: fallo o DF vac铆o) #}
{% elif session.get('simulation_ran') and (last_simulation_preview_df is none or last_simulation_preview_df.empty) %}
     <p class="alert alert-warning" style="margin-top: 1rem;">La 煤ltima simulaci贸n no produjo datos v谩lidos para la vista previa o hubo un error.</p>
{% endif %}


<div class="preview-section" style="margin-top: 2rem;">
    <h2>Historial de Simulaciones (Metadata)</h2>
    {% if simulation_history %}
        <div class="table-container" style="max-height: 400px;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Configuraci贸n</th>
                        <th>Registros</th>
                        <th>Distribuci贸n Etiquetas</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in simulation_history | reverse %} {# M谩s recientes primero #}
                    <tr>
                        <td>{{ entry.timestamp | format_datetime }}</td>
                        <td>
                            {# Usar .get para acceso seguro a config #}
                            Dur: {{ entry.config.get('duration', 'N/A') }}s,
                            Int: {{ entry.config.get('intensity', 'N/A') }},
                            Ataques: {{ entry.config.get('attacks', []) | join(', ') }}
                        </td>
                        <td>{{ entry.num_records }}</td>
                        <td>
                            {# Mostrar distribuci贸n de etiquetas de forma m谩s compacta #}
                            {% if entry.label_distribution %}
                                {% for label, count in entry.label_distribution.items() %}
                                     <span style="white-space: nowrap;">{{ label }}: {{ count }}</span><br>
                                {% endfor %}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>No se han ejecutado simulaciones.</p>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
    console.log("Simulator JS loaded");
</script>
{% endblock %}